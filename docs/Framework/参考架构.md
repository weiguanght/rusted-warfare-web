src/
├─ core/                                   # 【绝对确定性核心】(运行于 Worker，无 DOM/Window 访问)
│  ├─ loop/
│  │  ├─ simulation.ts                     # 核心循环：Tick 驱动器
│  │  ├─ pipeline.ts                       # 【关键】明确定义 Systems 执行顺序 (Command->Logic->Phys->Check)
│  │  ├─ game-state.ts                     # 全局状态根 (Tick数, 玩家列表, RNG 状态)
│  │  └─ checksum.ts                       # 状态哈希计算 (CRC32/XOR 校验，含 RNG 调用计数)
│  ├─ math/
│  │  ├─ fixed.ts                          # 定点数基础运算 (Add/Sub/Mul/Div/Sqrt)
│  │  ├─ trig-lut.ts                       # 【关键】三角函数查表 (Sin/Cos/Atan2) 消除跨浏览器差异
│  │  ├─ vector2-fixed.ts                  # 定点向量运算
│  │  ├─ rng.ts                            # 可重播的伪随机数生成器 (XorShift32)
│  │  └─ spatial-grid.ts                   # 空间哈希网格 (用于 O(1) 查询单位软碰撞/推挤)
│  ├─ ecs/
│  │  ├─ entity-manager.ts                 # ID 分配与回收 (Generational Index)
│  │  ├─ archetypes.ts                     # 实体预设模板 (Unit, Building, Projectile)
│  │  ├─ components/                       # 【SoA 内存布局】使用 TypedArray 而非 Object
│  │  │  ├─ transform-soa.ts               # pos(x,y), height, dir, radius (Int32Array)
│  │  │  ├─ movement-soa.ts                # moveType, speed, targetIndex, isMoving
│  │  │  ├─ combat-soa.ts                  # hp, shield, cooldowns, attackState
│  │  │  ├─ team-soa.ts                    # teamId, colorId, fogMask
│  │  │  └─ logic-data.ts                  # Mod 自定义变量存储
│  │  └─ systems/
│  │     ├─ command-system.ts              # 1. 解析与验证玩家指令
│  │     ├─ resource-system.ts             # 2. 经济结算
│  │     ├─ logic-system.ts                # 3. 运行 Mod 编译后的逻辑脚本
│  │     ├─ pathfinding-system.ts          # 4. 路径规划 (A* 请求处理)
│  │     ├─ movement-system.ts             # 5. 物理移动与推挤 (移植自 y.java)
│  │     ├─ combat-system.ts               # 6. 战斗与伤害判定
│  │     ├─ projectile-system.ts           # 7. 弹道更新
│  │     └─ fog-system.ts                  # 8. 战争迷雾更新
│  ├─ pathfinding/                         # 【移植版寻路】
│  │  ├─ path-engine.ts                    # 核心算法 (A* + 局部避障)
│  │  ├─ memory-layout.ts                  # 寻路专用内存池 (Flat Int32Array)
│  │  └─ cost-calculator.ts                # 地形代价 + 移动类型掩码计算
│  ├─ logic/                               # 【Mod 逻辑引擎】
│  │  ├─ logic-compiler.ts                 # JIT: 将 "hp<50" 编译为安全 JS 函数
│  │  ├─ logic-scope.ts                    # 运行时上下文 (self, global)
│  │  └─ ini-definitions.ts                # 单位属性定义表
│  └─ data/
│     ├─ mod-loader.ts                     # Mod 加载与注册
│     ├─ serialization.ts                  # 二进制快照 (用于存盘/断线重连)
│     └─ version-compat.ts                 # 旧版存档兼容层
│
├─ adapters/                               # 【平台适配层】(运行于主线程)
│  ├─ worker-bridge/
│  │  ├─ sim-worker-client.ts              # 主线程端 Worker 包装器
│  │  └─ message-protocol.ts               # 通信协议 (Command/Snapshot/SyncEvent)
│  ├─ render/
│  │  ├─ pixi-app.ts                       # PixiJS 入口
│  │  ├─ interpolator.ts                   # 【关键】渲染插值器 (平滑 30Hz 逻辑至 144Hz 屏幕)
│  │  ├─ layers/
│  │  │  ├─ tile-layer.ts                  # 地形渲染 (分块优化)
│  │  │  ├─ unit-layer.ts                  # 单位渲染 (InstancedMesh / ParticleContainer)
│  │  │  └─ ui-overlay.ts                  # 血条、选中圈
│  │  └─ assets/
│  │     └─ texture-atlas.ts               # 纹理图集管理
│  ├─ net/
│  │  ├─ lockstep-manager.ts               # 帧同步控制器 (Buffer, RTT调整, 追帧)
│  │  ├─ transport-ws.ts                   # WebSocket 实现
│  │  └─ transport-p2p.ts                  # WebRTC/WebTransport 实现
│  ├─ input/
│  │  ├─ input-mapper.ts                   # 键鼠操作 -> 游戏 Command
│  │  └─ selection-manager.ts              # 客户端选中状态管理
│  └─ io/
│     ├─ vfs.ts                            # 虚拟文件系统 (支持 Zip/OPFS)
│     └─ ini-parser-tolerant.ts            # 【关键】高容错 INI 解析器
│
├─ worker/
│  ├─ sim-worker.ts                        # 主逻辑 Worker 入口
│  └─ ai-worker.ts                         # [预留] 独立 AI 思考 Worker (异步计算)
│
├─ tools/                                  # 【开发与调试工具】
│  ├─ replay-inspector/                    # [新增] 网页版录像分析器 (可视化 Diff)
│  │  ├─ index.html
│  │  └─ inspector-app.ts
│  ├─ headless-runner.ts                   # 命令行运行 Core (用于测试)
│  └─ desync-checker.ts                    # 自动对比工具
│
├─ tests/                                  # 【测试套件】
│  ├─ unit/                                # 基础单元测试
│  │  ├─ fixed-math.test.ts
│  │  └─ spatial-grid.test.ts
│  └─ integration/                         # 集成/确定性测试
│     ├─ scenarios/                        # 测试场景 (JSON 描述)
│     └─ determinism.spec.ts               # 给定种子+指令，验证 Hash 是否匹配
│
├─ ui/                                     # HTML/React/Vue UI (非 Canvas 部分)
│  ├─ hud/                                 # 建造栏, 资源面板
│  ├─ lobby/                               # 大厅, 房间列表
│  └─ settings/                            # 设置菜单
│
├─ types/
│  ├─ global.d.ts
│  ├─ simulation.d.ts
│  └─ protocol.d.ts
│
├─ main.ts                                 # 应用启动入口
├─ constants.ts                            # 全局常量 (TickRate, MaxUnits)
└─ vite.config.ts                          # 构建配置