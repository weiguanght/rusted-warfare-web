#Mod路径

Web 游戏 **“资源打包” (Asset Bundling)**，把ini转成json，然后按mod分类，把一个mod里的所有ini2json文件合并在一起，方便解析器读取

对于《铁锈战争》这种可能有几百个小文件的 Mod 来说，如果在网页端一个个去请求 `.ini` 文件，浏览器会发起几百次 HTTP 请求，导致加载非常慢。**把它们合并成一个大的 JSON 文件，不仅加载快，而且解析起来也比在浏览器里解析文本要高效得多。**

但是，这样做有几个**关键注意事项**，需要在设计转换工具时考虑到：

### 关键设计要点

1.  **必须保留文件路径 (Virtual File System)**

      * 原版逻辑里有 `copyFrom: ../../units/tank.ini`。
      * 如果你只是把内容合并了，游戏引擎就不知道“谁是谁的父类”了。
      * **解决方案**：JSON 的结构不能是扁平的，必须是一个以**文件路径为 Key** 的大字典。

2.  **处理重复的 Section (数组问题)**

      * 普通的 INI 解析器遇到同名 Section 可能会覆盖。但《铁锈战争》通常使用 `[turret_1]`, `[turret_2]` 这种带后缀的写法，这在 JSON 里天然就是不同的 Key，所以问题不大。
      * **注意**：如果是完全同名的 Section（虽然少见），需要转换为数组。

3.  **不要在打包阶段处理逻辑**

      * 不要在转换成 JSON 时处理 `${hp + 100}` 这种变量替换，也不要处理 `copyFrom` 继承。
      * **原则**：这个 JSON 只是 `.ini` 文件的“另一种存储格式”。逻辑解析（继承、数学运算）依然要在游戏运行时进行。

-----

### 目标 JSON 结构示例

我们要让 AI 生成的打包脚本，最终输出这样的格式：

```json
// mod_assets.json
{
  "mod_info": {
    "name": "My Cool Mod",
    "version": "1.0"
  },
  "files": {
    "units/tank/tank.ini": {
      "core": {
        "name": "heavyTank",
        "mass": "3000",
        "copyFrom": "base_tank.ini"
      },
      "graphics": {
        "image": "tank.png"
      },
      "turret_1": {
        "x": "0",
        "y": "5"
      }
    },
    "units/tank/base_tank.ini": {
      "core": { "hp": "500" }
    }
  }
}
```

-----

### 给 AI 的 Prompt (生成打包工具)

你需要一个在电脑上运行的脚本（比如用 Node.js），在把游戏上传到网页之前，先运行这个脚本处理资源。

**任务目标**：写一个 Node.js 脚本，扫描文件夹，把所有 ini 转成一个 JSON。

> **Prompt (Node.js 打包脚本)：**
> “请帮我写一个 Node.js 脚本，用于打包《铁锈战争》的 Mod 资源。
>
> **输入**：一个包含 Mod 文件的文件夹路径（例如 `./mods/example_mod/`）。
> **输出**：一个 `mod_bundle.json` 文件。
>
> **具体要求：**
>
> 1.  **递归扫描**：遍历文件夹内所有的 `.ini` 文件。
> 2.  **INI 转 JSON**：
>       - 读取每个 `.ini` 文件的内容。
>       - 将其转换为 JSON 对象。结构为 `Section -> Key -> Value`。
>       - 所有的 Value 保持为**字符串**（不要尝试转换成数字或布尔值，保留原始文本）。
>       - 忽略以 `#` 开头的注释行。
>       - 如果遇到重名的 Key（极少见，但为了保险），保留最后一个。
> 3.  **构建虚拟文件系统结构**：
>       - 最终的 JSON 根对象里有一个 `files` 字段。
>       - Key 必须是该文件相对于 Mod 根目录的**相对路径**（例如 `units/tanks/heavy.ini`），并在 Windows 下要把反斜杠 `\` 替换为正斜杠 `/`。
> 4.  **容错性**：如果某个 ini 文件格式很烂（比如少了个等号），跳过该行并打印警告，不要报错停止。
> 5.  使用原生 Node.js 的 `fs` 模块，尽量不要依赖复杂的第三方 INI 库，因为我们需要定制化解析逻辑（比如允许 key 中包含特殊符号）。”

-----

### 给 AI 的 Prompt (前端适配器)

有了 JSON 文件后，你之前的 `IniParser` 也需要修改。它不再读取文本文件，而是直接从内存里的 JSON 对象读取数据。

**任务目标**：修改游戏代码，让它支持从 JSON 加载 Mod。

> **Prompt (前端 JSON 加载适配)：**
> “我们改变了 Mod 的加载策略。现在不再通过 HTTP 请求读取 `.ini` 文本文件，而是预先加载了一个大的 `mod_bundle.json`。
>
> 请帮我修改/创建一个 `ModLoader` 类。
> **要求：**
>
> 1.  **虚拟文件系统 (VFS)**：
>
>       - 维护一个 `Map<Path, IniData>`。
>       - 提供 `loadBundle(json: any)` 方法，把 JSON 数据填充进 Map。
>       - 提供 `getFile(path: string)` 方法，支持通过相对路径查找数据。
>
> 2.  **修改 IniParser**：
>
>       - 原来的 `IniParser` 是解析字符串的。现在请增加一个静态方法 `fromJSON(data: any)`。
>       - 它直接把 JSON 对象转换为 `IniParser` 实例，供游戏逻辑使用。
>
> 3.  **处理 copyFrom**：
>
>       - 这一点很重要：当我们在 JSON 数据中读取到 `copyFrom: base.ini` 时，我们需要通过 `ModLoader.getFile('base.ini')` 去查找父级数据，然后进行合并。请写出这个递归查找并合并的逻辑框架。”

### 给小白的建议

1.  **先跑通流程**：你可以先让 AI 写第一个 Prompt（打包脚本）。你在自己电脑上安装 Node.js，运行这个脚本，看看生成的 `mod_bundle.json` 是否是你想要的样子（打开看看结构对不对）。
2.  **验证路径**：重点检查 JSON 里的 Key（路径）是不是对的。如果路径不对（比如只有文件名没有文件夹），以后游戏引擎会找不到 `copyFrom` 的目标。
3.  **图片怎么办？**：图片依然保持原样，让浏览器去加载。JSON 里只存数据。
